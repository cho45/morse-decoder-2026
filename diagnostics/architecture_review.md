# モデルアーキテクチャおよび特徴量設計に関する徹底レビュー

## 1. 入力特徴量: なぜ Mel-Spectrogram なのか？

CW（モールス信号）デコードにおいて、入力特徴量の選択は極めて重要です。現状の `MelSpectrogram` 採用の是非について分析します。

### CW信号の特性
*   **基本構造**: 特定周波数（約700Hz）の正弦波の ON/OFF 変調。
*   **重要情報**: 「いつ始まり、いつ終わったか（時間情報）」と「信号の長さ（持続時間）」。
*   **不要情報**: 位相情報、高調波成分（矩形波でない限り）、帯域外のノイズ。

### Mel-Spectrogram vs 他の手法

| 特徴量 | CWへの適合性 | メリット | デメリット |
| :--- | :--- | :--- | :--- |
| **Raw Waveform** | △ (過剰) | 全情報を含む。End-to-Endでフィルタも学習可能。 | 次元数が膨大 (16kHz)。学習収束が遅い。不要な位相情報に惑わされる可能性。 |
| **STFT (Linear)** | ◯ (妥当) | 周波数解像度が線形。特定の周波数をピンポイントで狙える。 | 次元数がまだ多い (N_FFT/2)。 |
| **Mel-Spectrogram** | **◎ (設定次第)** | **エネルギー集約による次元圧縮。** 人間の聴覚特性に合わせる必要はないが、帯域制限フィルタバンクとして機能する。 | 時間分解能と周波数分解能のトレードオフ。パラメータ設定を誤ると信号が「ぼやける」。 |

### 現状設定の評価と問題点
現在の設定:
*   `sample_rate`: 16000
*   `n_fft`: 400 (25ms)
*   `hop_length`: 160 (10ms)
*   `n_mels`: 16 (500Hz - 900Hz)

**【問題点】時間分解能の欠如 (Time Resolution Mismatch)**
*   CWの短点（Dot）の長さは、20 WPM で約 60ms、40 WPM で約 30ms です。
*   `n_fft=400` (25ms) という窓幅は、信号の変化点（立ち上がり・立ち下がり）を 25ms の幅で平均化（平滑化）してしまいます。
*   これは 40 WPM の短点 (30ms) に対して致命的であり、信号のON/OFFが不明瞭になり、モデルが自信を持って検出できなくなる主原因です。
*   **結論**: メルスペクトログラムという手法自体は間違っていませんが、**窓サイズ (n_fft) が大きすぎます**。CWのような過渡的な信号には、より短い窓（例: 10-15ms）が必要です。

## 2. バックボーン: なぜ Conformer なのか？

### CWデコードに必要な能力
1.  **局所的な特徴抽出**: エッジ検出（信号のON/OFFの境界）。 -> **CNN** が得意。
2.  **大域的な文脈理解**: リズムの把握、WPM（速度）への適応、単語間隔の認識。 -> **Transformer (Self-Attention)** が得意。

### Conformer の適合性
*   Conformer は CNN と Transformer を直列に組み合わせたアーキテクチャであり、CWデコードの要件に **理想的に合致** しています。
*   **CNNモジュール**: 1D-Conv により、スペクトログラム上の局所的なパターン（短点・長点の形状）を捉えます。
*   **Self-Attentionモジュール**: 系列全体を見渡し、「短・短・短」という並びから「S」という文字を推論したり、前後の間隔から現在の通信速度（WPM）を暗黙的に推定したりします。

**【問題点】サブサンプリング (Subsampling)**
*   現在の `ConvSubsampling` (stride=2) は、時間軸を 1/2 に圧縮しています。
*   入力特徴量の段階ですでに時間分解能が不足している上に、さらに情報を間引いているため、高速なモールス信号の微細なタイミング情報が消失しています。

## 3. 損失関数: なぜ CTC Loss なのか？

### CTC (Connectionist Temporal Classification) の特性
*   入力長（フレーム数）と出力長（文字数）が異なるシーケンス変換タスクに最適。
*   「文字」と「文字」の間のアライメント（どの区間がどの文字に対応するか）を明示的に与える必要がない。

### CWにおける課題
*   **Blank Bias**: CTCは「確信が持てない区間」をBlank（無音）として処理する傾向が強いです。
*   **Peak Peeping**: CTCは信号の持続時間（Duration）を直接モデル化せず、信号が存在する区間のどこかで「スパイク」状に確率を上げる挙動を示します。
*   CWでは「短点」と「長点」の **長さの違い** が決定的な情報ですが、CTCはこの長さ情報を直接的な損失として扱わないため、学習初期に苦戦する可能性があります。

**【改善策】**
*   現在導入されている **補助タスク (BCE Loss for Signal Detection)** は非常に有効です。これにより、CTCが苦手とする「信号の存在区間（長さ）」を明示的にエンコーダに学習させることができます。
*   ただし、現在の学習ログを見ると、この補助タスクすら機能不全（Lossが下がらない）に陥っている可能性があります。これはやはり入力特徴量の時間分解能不足により、そもそも信号が見えていないことが原因と考えられます。

## 4. 総合結論と修正方針

モデルアーキテクチャ（Mel-Spec + Conformer + CTC）の **構成要素自体は、CWデコードに対して論理的に妥当** です。
しかし、**ハイパーパラメータの設定（特に時間分解能に関連するもの）が、対象とする信号（CW）の物理特性と不整合を起こしています。**

よって、モデルを根本的に作り直す必要はありませんが、以下の「チューニング」が不可欠です。

1.  **時間分解能の最適化**:
    *   `N_FFT`: 400 (25ms) -> **256 (16ms)** または **200 (12.5ms)**。窓幅を狭くし、過渡特性を捉える。
    *   `HOP_LENGTH`: 160 (10ms) -> **128 (8ms)** または **80 (5ms)**。フレームレートを上げる。
    *   `SUBSAMPLING`: 廃止 (Stride=1)。情報を間引かない。

2.  **周波数分解能の維持**:
    *   `N_FFT` を下げると周波数分解能が落ちますが、CWは 500-900Hz の狭帯域に集中しているため、`N_MELS=16` 程度であれば問題ありません。

3.  **初期化の適正化**:
    *   CTCのBlankバイアスを強制的に下げ、学習初期の「沈黙」を防ぐ。

この方針でパラメータを修正することで、現在のアーキテクチャのポテンシャルを正しく発揮できるはずです。